# Get staged files that spotless can format
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(java|js|ts|css)$|pom\.xml$' || true)

if [ -n "$STAGED_FILES" ]; then
    echo "Formatting with Spotless..."

    UPSTREAM_REF="$(git rev-parse --abbrev-ref --symbolic-full-name @{u})"
    BASE_SHA="$(git merge-base HEAD "$UPSTREAM_REF")"
    if ! mvn spotless:apply -q -Dspotless.ratchetFrom="$BASE_SHA"; then
        echo "Spotless formatting failed."
        exit 1
    fi

    echo "$STAGED_FILES" | xargs git add
    echo "Formatting complete."
fi
