#!/bin/bash
#
# Pre-commit hook that runs spotless:apply on staged files.
#
# If you have custom pre-commit logic, put it in .git/hooks/pre-commit.local
# and it will be called after formatting.
#

REPO_ROOT=$(git rev-parse --show-toplevel)
LOCAL_HOOK="$REPO_ROOT/.git/hooks/pre-commit.local"

# Get staged files that spotless can format
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(java|js|ts|css)$|pom\.xml$')

if [ -n "$STAGED_FILES" ]; then
    echo "Formatting with Spotless..."

    cd "$REPO_ROOT"
    if ! mvn spotless:apply -q; then
        echo "Spotless formatting failed."
        exit 1
    fi

    echo "$STAGED_FILES" | while read -r file; do git add "$file"; done
    echo "Formatting complete."
fi

# Run local hook if it exists
[ -x "$LOCAL_HOOK" ] && exec "$LOCAL_HOOK"
exit 0
