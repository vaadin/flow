<dom-module id="flow-component-renderer">
    <template> 
        <slot></slot>
    </template>
     
    <script>
    class FlowComponentRenderer extends Polymer.Element {
      static get is() { return 'flow-component-renderer'; }
      static get properties() {
          return {
            containerid: {
                type: String,
                observer: '_attributesChanged',
                reflectToAttribute: true
            },
            keyname: {
                type: String,
                value: 'key',
                observer: '_attributesChanged',
                reflectToAttribute: true
            },
            key: {
                type: String,
                observer: '_attributesChanged',
                reflectToAttribute: true
            }
          };
        }
      
      
      connectedCallback() {
    	  super.connectedCallback();
    	  this._attachRenderedComponentIfAble();
      }
      
      _attributesChanged() {
    	this._attachRenderedComponentIfAble();
      }
      
      _attachRenderedComponentIfAble() {
        if (!this.key || !this.containerid || !this.keyname) {
       	 	return;
        }
        if (!this.container) {
          	this.container = document.getElementById(this.containerid); 
          	if (!this.container) {
          		console.error("The container for renderered components with id " + this.containerid + " could not be found in the document.");
          		return;
          	}
      	}
  		if (this.renderedComponent) {
  			this.container.appendChild(this.renderedComponent);
  		}
  		this.renderedComponent = this.container.querySelector("["+this.keyname+"='"+this.key+"']");
  		if (this.renderedComponent) {
  			this.appendChild(this.renderedComponent);
  		} else {
  			const thisElement = this;
  			new MutationObserver(function(mutations, observer) {
  				for (let m = 0; m < mutations.length; ++m) {
  					let mutation = mutations[m];
      				for (let i = 0; i < mutation.addedNodes.length; ++i) {
      					let node = mutation.addedNodes[i];
      					if (node.getAttribute(thisElement.keyname) === thisElement.key) {
      						thisElement.renderedComponent = node;
      						thisElement.appendChild(thisElement.renderedComponent);
      						observer.disconnect();
      						return;
      					}
      				}
  				}
  			}).observe(this.container, { childList: true });
  		}
      }
      
      disconnectedCallback() {
    	  if (this.container && this.renderedComponent) {
    	  	this.container.appendChild(this.renderedComponent);
    	  	this.renderedComponent = null;
    	  }
    	  super.disconnectedCallback();
      }
      
    }
    window.customElements.define(FlowComponentRenderer.is, FlowComponentRenderer);
  </script>
</dom-module>