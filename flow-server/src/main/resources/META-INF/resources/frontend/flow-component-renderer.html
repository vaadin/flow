<dom-module id="flow-component-renderer"> 
  <template> 
    <slot></slot> 
  </template> 
  <script>
  class FlowComponentRenderer extends Polymer.Element {
    static get is() { return 'flow-component-renderer'; }
    static get properties() {
      return {
        nodeid: Number,
        appid: String
      };
    }
    static get observers() {
      return [
        '_asyncAttachRenderedComponentIfAble(appid, nodeid)'
      ]
    }
    
    constructor() {
      super();
      this.hidden = true;
    }
    
    _asyncAttachRenderedComponentIfAble() {
      if (!this.nodeid || !this.appid) {
        return;
      }
      this.hidden = true;
      this._debouncer = Polymer.Debouncer.debounce(
        this._debouncer,
        Polymer.Async.idlePeriod,
        () => this._attachRenderedComponentIfAble()
      );
    }

    _attachRenderedComponentIfAble() {
      const renderedComponent = window.vaadin.clients[this.appid].getByNodeId(this.nodeid);
      if (this.firstElementChild) {
        if (!renderedComponent) {
          this._clear();
          this._asyncAttachRenderedComponentIfAble();
        } else if (this.firstElementChild !== renderedComponent){
          this.replaceChild(renderedComponent, this.firstElementChild);
          this.hidden = false;
          this._notifyResize();
        } else {
          this.hidden = false;
        }
      } else {
        if (renderedComponent) {
          this.appendChild(renderedComponent);
          this.hidden = false;
          this._notifyResize();
        } else {
          this._asyncAttachRenderedComponentIfAble();
        }
      }
    }
    
    _clear() {
      while (this.hasChildNodes()) {
        this.removeChild(this.lastChild);
      }
    }

    _notifyResize(){
      // subclasses can override this method to execute custom logic on resize
    }
    
  }
  window.customElements.define(FlowComponentRenderer.is, FlowComponentRenderer);
  </script> 
</dom-module>
